name: BuildWebGL

on:
  push:
    branches:
    - master

jobs:
  BuildStartReportJob:
    runs-on: ubuntu-latest
    steps:
    - run: |
        git clone https://github.com/pCYSl5EDgo/WithAo
        cd WithAo
        git log --format=%B -n 1 $GITHUB_SHA > log.dat
        cat log.dat
        echo '{"content":"Start Building\n' $(cat log.dat) '"}"' > report.json
        cat report.json
        ls -l
        curl $WEBHOOK -X POST -H "Content-Type:application/json" --data-urlencode '@report.json'
      env:
        WEBHOOK: ${{ secrets.discord_webhook }}

  BuildJob:
    runs-on: ubuntu-latest
    container: docker://gableroux/unity3d:2018.4.9f1-webgl
    steps:
    - name: Initialize
      run: |
        mkdir artifact
        git clone https://github.com/pCYSl5EDgo/WithAo
        cd WithAo
        git checkout $GITHUB_SHA
        openssl aes-256-cbc -d -in Unity_v2018.x.ulf-cipher -k ${CYPHER_KEY} >> Unity_v2018.x.ulf
        /opt/Unity/Editor/Unity -buildTarget WebGL -logFile -manualLicenseFile Unity_v2018.x.ulf -batchmode -nographics -quit || exit 0
      env:
        CYPHER_KEY: ${{ secrets.cypher_key }}
    - name: Build
      run: /opt/Unity/Editor/Unity -quit -batchMode -noGraphics -silent-crashes -projectPath WithAo -logFile -buildTarget WebGL -executeMethod BuildWebGLPlayer.Build || exit 0
    - run: |
        ls -l WithAo
        ls -l artifact
    - uses: actions/upload-artifact@master
      with:
        path: artifact
        name: build

  PushJob:
    runs-on: ubuntu-latest
    needs: BuildJob
    steps:
    - name: Initialize netrc
      run: echo $netrc > ~/.netrc
      env:
        netrc: ${{ secrets.netrc }}
    - run: |
        git clone https://github.com/pCYSl5EDgo/WithAo
        cd WithAo
        git config --local user.name "pCYSl5EDgo"
        git config --local user.email "pCYSl5EDgo@yahoo.co.jp"
        git checkout -b gh-pages origin/gh-pages
        git clean -d -f
    - uses: actions/download-artifact@master
      with:
        path: WithAo
        name: build
    - run: |
        cd WithAo
        ls -l
        git add .
        git commit -a -m "[update]DLL Update of $GITHUB_SHA"
        git push origin gh-pages


  ReportJob:
    runs-on: ubuntu-latest
    needs: PushJob
    steps:
    - run: curl $WEBHOOK -X POST -H "Content-Type:application/json" -d "{\"content\":\"Build Complete!\\nCheck Repository! https://github.com/pCYSl5EDgo/WithAo/actions \\nPlay https://pCYSl5EDgo.github.io/WithAo\"}"
      env:
        WEBHOOK: ${{ secrets.discord_webhook }}